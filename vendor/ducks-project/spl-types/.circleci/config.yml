version: 2.1

orbs:
  codecov: codecov/codecov@4.0.1
  coveralls: coveralls/coveralls@2.2.1

# Define the jobs we want to run for this project
jobs:
  test:
    docker:
      - image: cimg/php:7.4-node
    steps:
      - checkout
      - run: php --version
      # - run: sudo apt-get install libxslt1-dev

      - run:
          name: Install PHP Extensions
          command: sudo -E install-php-extensions zip intl

      #- run:
      #    name: Install xDebug
      #    command: sudo pecl install xdebug-3.1.5 && docker-php-ext-enable xdebug

      - run: echo -e "[Date]\ndate.timezone = Europe/Paris" | sudo tee /usr/local/etc/php/php.ini > /dev/null
      - run: echo -e "memory_limit = -1" | sudo tee -a /usr/local/etc/php/conf.d/docker-php-memlimit.ini

      # composer require
      - run: composer require --dev --update-with-all-dependencies php-coveralls/php-coveralls

      # composer cache
      - restore_cache:
          keys:
          # "composer.json" can be used if "composer.json"
          # is not committed to the repository.
          - composer-v1-{{ checksum "composer.lock" }}
          # fallback to using the latest cache if no exact match is found
          - composer-v1-
      - run: composer install -n --prefer-dist
      - save_cache:
          key: composer-v1-{{ checksum "composer.lock" }}
          paths:
            - vendor

      # tests
      - run: composer unittest
      - run: composer atoumtest

      #- run:
      #    command: npm install && make test-coverage
      #    name: Install and Make

      # Stay commented Managed in github actions
      #- coveralls/upload
      #- codecov/upload

# Orchestrate our job run sequence
workflows:
  workflow:
    jobs:
      - test:
          filters:
            branches:
              only: /5\..*/
